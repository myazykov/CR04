# CR04 ТРЕБОВАНИЯ НА ВНЕСЕНИЕ ИЗМЕНЕНИЙ

## 1. ОБЩИЕ СВЕДЕНИЯ

Документ разработан на основании документа "CR01 ЗАПРОС НА ИЗМЕНЕНИЯ".

### 1.1. Термины и сокращения, используемые в документе

| Термин | Определение |
| :--- | :--- |
| ИС | Информационная система (в данном контексте 1С:УПП) |
| БП | Бизнес-процесс |
| ЗНИ | Запрос на изменения |
| РС | Регистр сведений |
| _ВидПродукции | Реквизит номенклатуры (Перечисление) |
| мбккКодУчета | Реквизит номенклатуры, используемый для поиска |
| Грузополучатель | Реквизит (Справочник.Контрагенты) |
| Организация | Реквизит (Справочник.Организации) |
| Склад | Реквизит (Справочник.Склады) |

### 1.2. Цели и задачи

Документ "Требования на внесения изменений" представляет собой документ, в котором сформулированы требования к изменению программного продукта, определены этапы разработки и регламентирован процесс приемосдаточных испытаний.
Задачи документа: фиксация требований заказчика, понимание объема работ, определение требований к конечному продукту, установка критериев приемки итоговых работ.

### 1.3. Ограничения документа

Документ "Требования на внесения изменений" устанавливает границы разработки. Любое изменение в согласованный документ должно регистрироваться как отдельный процесс через оформление документа «Протокол внесения изменений в техническое задание».
Все изменения, дополнения и уточнения формулировок в документе обязательно согласуются с заказчиком и им утверждаются.
Требования на внесения изменений это документ, содержащий исчерпывающую информацию, необходимую для постановки задач исполнителям на доработку информационной системы.
Указывается необходимость проведения тестирования, согласно пользовательского сценария, который будет описан в документе

---

## 2. БИЗНЕС-ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1. Предметная область и объект автоматизации

| | |
| :--- | :--- |
| **Бизнес-функция:** | Управление продажами, Оформление заказов |
| **Подразделение:** | Отдел продаж / Отдел по работе с клиентами |
| **Процесс:** | Автоматизированная загрузка заказов покупателей из внешнего файла (Обработка «Загрузка заказов Реклама (000000967)») |
| **Учетная система:** | 1С:Управление производственным предприятием (УПП) |
| **Участники:** | Менеджер по продажам, Оператор по вводу заказов |
| **Роли:** | Пользователь, имеющий доступ к запуску внешней обработки и созданию документов «Заказ покупателя» |

### 2.2. Описание проблемы и целей

**Описание проблемы:**

В текущей реализации внешней обработки «Загрузка заказов Реклама (000000967)» при создании нового документа «Заказ покупателя» поле **Организация** заполняется на основании настроек пользователя 1С, запустившего обработку. Аналогичная логика применяется для определения **Склада**.

Такой подход неудобен, если сотруднику требуется создавать заказы от имени разных организаций. В результате возникает необходимость вручную менять организацию после загрузки, что повышает риск ошибок. Это замедляет процесс оформления заказов и снижает производительность.

**Описание бизнес-функциональных целей:**

Реализовать в обработке «Загрузка заказов Реклама (000000967)» механизм автоматического определения значения поля **Организация** и **Склад** в зависимости от данных загружаемого файла, полностью исключив зависимость от настроек пользователя.

Правила заполнения «Организации»:
* Если `ВидПродукции` (определенный по первой номенклатуре) = "БЗП", то `Организация` = "Хлебный дом".
* Во всех остальных случаях — `Организация` = "Коломенский торговый дом".

Правила заполнения «Склада»:
* `Склад` определяется из РС «\_СкладыОтгрузкиДляГрузополучателей» по комбинации «Организация» + «Грузополучатель» + «\_ВидПродукции».

Изменения позволят:
* Исключить ручное вмешательство при выборе организации и склада.
* Повысить точность заполнения заказов.
* Сократить время оформления заказов и снизить риск ошибок операторов.
* Выполнить рефакторинг кода, убрав зависимость от настроек `Справочник.Пользователи`.

### 2.3. Назначение процесса

Автоматизированная пакетная загрузка документов «Заказ покупателя» в ИС 1С:УПП из внешнего файла Excel с помощью специализированной обработки «Загрузка заказов Реклама (000000967)».

### 2.6. Исключения

В контур изменений информационной системы не входит:
* Изменение других обработок загрузки.
* Изменение логики работы документа «Заказ покупателя» вне контекста данной обработки.
* Изменение механизма поиска номенклатуры (используется существующая функция).

### 2.7. Задачи адаптации и автоматизации бизнес-процесса

* **Снижение зависимости от ручного труда:** Исключение необходимости ручной корректировки поля «Организация» и «Склад» в созданных документах.
* **Сокращение ошибок:** Минимизация риска выбора некорректной организации или склада из-за человеческого фактора.
* **Повышение производительности:** Ускорение процесса оформления заказов.
* **Рефакторинг:** Полное устранение зависимости логики обработки от настроек в карточке `Справочника.Пользователи` (`ОсновнаяОрганизация`, `ОсновнойСклад`, `ВидПродукции`).

---

## 3. СПЕЦИФИКАЦИЯ НА ИЗМЕНЕНИЯ

### 3.1. Требования к изменениям

Требования сгруппированы по областям доработки внешней обработки «Загрузка заказов Реклама (000000967)».

#### 3.1.1. Требования к интерфейсу (Очистка)

1.  Удалить информирование из заголовка: В процедуре `ПриОткрытии()` полностью удалить код, отвечающий за вывод `текОрганизация` и `тексклад` в заголовок формы (строки 19-21 в текущей нумерации).
2.  Удалить информирование с формы: Полностью удалить процедуру `ОбновитьНадписьОрганизациюПоУмолчанию()` (начиная со строки 1288) и ее вызов из `ПриОткрытии()`.
3.  Удалить элемент: Удалить с формы элемент `НадписьОрганизацияПоУмолчанию`.

#### 3.1.2. Требования к основной логике (Процедура `ОбработатьФайл`)

Все описанные ниже действия должны выполняться **один раз** после определения переменной `Магазин(Грузополучатель)` и **до** начала цикла `Для НомерСтроки = ПерваяСтрока....`

**Шаг 1. Определение Вида Продукции и Организации**
1.  Прочитать код номенклатуры из ячейки **R5C1** (`ТабличныйДокумент.Область("R" + ПерваяСтрока + "C" + Номенклатура_Колонка)`).
2.  Выполнить поиск номенклатуры по этому коду через реквизит `мбккКодУчета` (используя существующую функцию `найтиНоменклатуру`).
3.  Получить `_ВидПродукции` из найденного элемента номенклатуры. Сохранить его в новую переменную, например, `ВидПродукцииФайла`.
4.  На основании `ВидПродукцииФайла` определить организацию. Сохранить ее в новую переменную, например, `ЕдинаяОрганизация`:
    * **Если** `ВидПродукцииФайла = Перечисления._ВидПродукции.БЗП`
    * **Тогда** `ЕдинаяОрганизация = Справочники.Организации.НайтиПоКоду("000000007")` (Хлебный дом)
    * **Иначе** `ЕдинаяОрганизация = Справочники.Организации.НайтиПоКоду("000000008")` (Коломенский)
5.  **Обработка ошибок:** Если код в R5C1 не найден, ИЛИ номенклатура по коду не найдена, ИЛИ у найденной номенклатуры не заполнен `_ВидПродукции` — прервать обработку файла (`Возврат;`) и вывести пользователю в `Ошибки` точную причину.

**Шаг 2. Определение Склада (СкладГруппа)**
1.  **Удалить старую логику:** Полностью удалить строку `СкладГруппа = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(...)` (стр. 331).
2.  **Добавить новую логику:** Выполнить запрос к `РегистрыСведений._СкладыОтгрузкиДляГрузополучателей`.
    * В запросе использовать `ВЫБРАТЬ ПЕРВЫЕ 1 Склад`.
    * В секции `ГДЕ` использовать отбор по **трем** реквизитам:
        * `Организация = &ЕдинаяОрганизация` (из Шага 1)
        * `Грузополучатель = &Магазин` (существующая переменная)
        * `_ВидПродукции = &ВидПродукцииФайла` (из Шага 1)
3.  Результат запроса присвоить переменной `СкладГруппа`.
4.  **Обработка ошибок:** Если запрос не вернул ни одной строки (склад не найден), прервать обработку файла (`Возврат;`) и вывести ошибку: "Не найден склад отгрузки для Организации, Грузополучателя и Вида Продукции".

**Шаг 3. Корректировка цикла обработки строк**
1.  **Удалить старую логику:** Полностью удалить блок определения `ОрганизацияНом` внутри цикла (строки 383-402).
2.  **Использовать новые данные:** Внутри цикла, при добавлении строки в таблицу `Заказы` (`нСтр = Заказы.Добавить()`), присвоить:
    * `нСтр.Организация = ЕдинаяОрганизация;`
    * `нСтр.ВидПродукции = ВидПродукцииФайла;` (добавить новую колонку в ТЗ `Заказы`)

#### 3.1.3. Требования к зависимым процедурам

1.  **Процедура `ПроверкаРекламныхОтгрузок`:**
    * Модифицировать вызов этой функции в цикле (внутри `ОбработатьФайл`).
    * Передавать в нее `ЕдинаяОрганизация` и `ВидПродукцииФайла` в качестве параметров.
    * Внутри самой `ПроверкаРекламныхОтгрузок` убрать код, получающий организацию из настроек пользователя, и использовать переданные параметры в запросе.
2.  **Процедура `КоманднаяПанель2СоздатьЗаказы` (Логика Договоров):**
    * Текущая логика выбора договора/типа цен (ХБ или Кондитерка) зависит от `ТекущийПользователь.ВидПродукции` (в районе строк 751-802).
    * При обходе сгруппированных данных использовать `стр.ВидПродукции` (которую добавили в Шаге 3) для выбора правильного договора, полностью убрав зависимость от `ТекущийПользователь.ВидПродукции`.

---

## 4. ТРЕБОВАНИЯ К ПОДГОТОВКЕ СИСТЕМЫ, СРЕДЫ, ОКРУЖЕНИЯ, ДАННЫХ

### 4.1. Настройка информационной системы до и после внедрения изменений

Для корректной работы доработанной обработки необходимо обеспечить, чтобы **Регистр Сведений «\_СкладыОтгрузкиДляГрузополучателей»** был заполнен актуальными данными.

Логика доработки (Шаг 2 в п. 3.1.2) выполняет отбор по трем реквизитам: «Организация», «Грузополучатель», «\_ВидПродукции». Отсутствие записи в регистре для требуемой комбинации прервет выполнение обработки и выдаст ошибку пользователю.

### 4.2. Модификация исторических данных

Внесение изменений в исторические данные не требуется.

Изменения не должны распространяться на ранее созданные документы «Заказ покупателя». Доработка затрагивает только логику внешней обработки «Загрузка заказов Реклама (000000967)» в момент создания новых документов.

---

## 5. КРИТЕРИИ ДОСТИЖЕНИЯ ЦЕЛЕЙ

### 5.1. Критерии приемки работ пользователем

Условиями, которым должна соответствовать ИС, чтобы быть принятой, являются:
1.  При загрузке заказа из обработки поле **Организация** в созданном документе «Заказ покупателя» заполняется автоматически по указанному правилу.
2.  При `ВидПродукции` (первой номенклатуры) = "БЗП" в заказе создается организация "Хлебный дом".
3.  Во всех остальных случаях в заказе создается организация "Коломенский торговый дом".
4.  Поле **Склад** заполняется автоматически на основании данных из РС «\_СкладыОтгрузкиДляГрузополучателей» (по связке Организация + Грузополучатель + ВидПродукции).
5.  Возможность ручного изменения значения полей в *созданном* документе сохраняется.
6.  Информационные надписи об организации/складе по умолчанию на форме обработки отсутствуют.
7.  Результаты тестирования (п. 5.1.1) подтверждают корректность заполнения в 100% проверенных случаев.

### 5.1.1 Выполнение пользовательского сценария

Детализированное описание пути пользователя:

| № шага | Описание шага | Роль | Путь | Выполняемые действия | Ожидаемый результат |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Сценарий 1: Продукция "БЗП"** | | | | | |
| 1.1 | Запуск обработки | Оператор | Файл -> Открыть | Пользователь запускает обработку «Загрузка заказов Реклама (000000967)» | Открыта форма обработки. Надписи `НадписьОрганизацияПоУмолчанию` отсутствуют. |
| 1.2 | Выбор файла | Оператор | Форма обработки | Нажать "Выбрать файл", указать файл Excel, у которого в R5C1 код номенклатуры с `ВидПродукции` = "БЗП". | Путь к файлу отображен на форме. |
| 1.3 | Загрузка | Оператор | Форма обработки | Нажать "Обработать файл" | Обработка выполнена без ошибок. Выведено сообщение об успешной загрузке. |
| 1.4 | Проверка | Оператор | Журнал "Заказы покупателей" | Открыть созданный документ «Заказ покупателя» | Документ создан. Поле **Организация** = "Хлебный дом". Поле **Склад** = склад, определенный из РС по ключу ("Хлебный дом" + Грузополучатель + "БЗП"). |
| **Сценарий 2: Продукция "Кондитерка" (Не БЗП)** | | | | | |
| 2.1 | Запуск обработки | Оператор | Файл -> Открыть | Пользователь запускает обработку | Открыта форма обработки. |
| 2.2 | Выбор файла | Оператор | Форма обработки | Нажать "Выбрать файл", указать файл Excel, у которого в R5C1 код номенклатуры с `ВидПродукции` != "БЗП". | Путь к файлу отображен на форме. |
| 2.3 | Загрузка | Оператор | Форма обработки | Нажать "Обработать файл" | Обработка выполнена без ошибок. Выведено сообщение об успешной загрузке. |
| 2.4 | Проверка | Оператор | Журнал "Заказы покупателей" | Открыть созданный документ «Заказ покупателя» | Документ создан. Поле **Организация** = "Коломенский торговый дом". Поле **Склад** = склад, определенный из РС по ключу ("Коломенский" + Грузополучатель + ВидПродукции). |
| **Сценарий 3: Ошибка (Не найдена номенклатура)** | | | | | |
| 3.1 | Выбор файла | Оператор | Форма обработки | Указать файл, у которого в R5C1 пустая ячейка или некорректный код. | Путь к файлу отображен. |
| 3.2 | Загрузка | Оператор | Форма обработки | Нажать "Обработать файл" | Обработка прервана. В окне ошибок выведено сообщение "Номенклатура по коду... не найдена" (или аналогичное). Документы не созданы. |
| **Сценарий 4: Ошибка (Не найден склад)** | | | | | |
| 4.1 | Выбор файла | Оператор | Форма обработки | Указать корректный файл, но для комбинации (Орг + Грузополучатель + ВидПродукции) нет записи в РС `_СкладыОтгрузки...` | Путь к файлу отображен. |
| 4.2 | Загрузка | Оператор | Форма обработки | Нажать "Обработать файл" | Обработка прервана. В окне ошибок выведено сообщение "Не найден склад отгрузки...". Документы не созданы. |

### 5.2. Сценарий тестовых испытаний (для тестирования инженерами)

### 5.2.1. Тестирование пользовательского сценария

**Необходимо** проведение тестирования, согласно всем пользовательским сценариям, описанным в п. 5.1.1.

### 5.2.2. Нагрузочное тестирование

Проведение нагрузочного тестирования **не требуется**. Изменения касаются логики определения реквизитов при запуске обработки и не влияют на массовые операции.

### 5.2.3. Дымовое тестирование

**Необходимо** проведение дымового тестирования для проверки, что обработка запускается, корректно открывается и не нарушена базовая функциональность (выбор файла, запуск).

### 5.2.4. Интеграционное тестирование

**Необходимо** проведение интеграционного тестирования. Проверки должны включать:
1.  Корректное чтение данных из ячейки R5C1 файла Excel.
2.  Корректный поиск номенклатуры по `мбккКодУчета`.
3.  Корректный поиск записи в РС «\_СкладыОтгрузкиДляГрузополучателей».
4.  Корректное создание документа «Заказ покупателя» с заполнением полей «Организация», «Склад» и выбором «Договора» на основе `ВидаПродукцииФайла`.

### 5.3. Инструкции

**Да**.
1.  **Актуализировать инструкцию Администратора ИС:** Добавить требование об обязательном и своевременном заполнении регистра сведений «\_СкладыОтгрузкиДляГрузополучателей» для корректной работы обработки.
2.  **Инструкция пользователя:** Актуализация не требуется, так как порядок действий пользователя не меняется (удаленные элементы носили информационный характер).